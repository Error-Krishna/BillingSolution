{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications - Nexus Bills{% endblock %}

{% block page_title %}Notifications{% endblock %}
{% block page_subtitle %}Manage your alerts and updates{% endblock %}

{% block extra_css %}
<style>
    /* Add custom styles for notifications page */
    .notification-item {
        transition: all 0.3s ease;
    }
    
    .notification-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(255, 102, 0, 0.1);
    }
    
    .notification-badge {
        animation: notificationPulse 2s infinite;
    }
    
    @keyframes notificationPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Loading animation */
    .loading-dots:after {
        content: '.';
        animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60% { content: '...'; }
        80%, 100% { content: ''; }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="notificationPage()" x-init="loadNotifications()" class="max-w-6xl mx-auto">
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-white mb-2">Notifications</h1>
                <p class="text-gray-400">
                    <span x-text="totalCount" class="font-semibold text-neon"></span> total notifications
                    <span x-show="unreadCount > 0" class="ml-4">
                        <span x-text="unreadCount" class="font-semibold text-red-400"></span> unread
                    </span>
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button @click="markAllAsRead()" 
                        :disabled="unreadCount === 0"
                        :class="unreadCount === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-500/20'"
                        class="px-4 py-2 rounded-lg border border-green-500 text-green-400 text-sm font-medium transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span>Mark all as read</span>
                </button>
                <button @click="clearAll()" 
                        class="px-4 py-2 rounded-lg border border-red-500 text-red-400 text-sm font-medium hover:bg-red-500/20 transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Clear all</span>
                </button>
                <button @click="toggleFilters()" 
                        class="px-4 py-2 rounded-lg border border-mystic text-gray-300 text-sm font-medium hover:bg-mystic/30 transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                    </svg>
                    <span>Filters</span>
                    <span x-show="activeFilters > 0" x-text="activeFilters" class="ml-1 h-5 w-5 bg-neon text-white text-xs rounded-full flex items-center justify-center"></span>
                </button>
            </div>
        </div>

        <div x-show="showFilters" x-transition class="mb-6 bg-space-black border border-mystic rounded-lg p-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <h3 class="text-lg font-semibold text-white">Filter Notifications</h3>
                <button @click="clearFilters()" class="text-sm text-gray-400 hover:text-white transition-colors">
                    Clear all filters
                </button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.status" value="unread" @change="applyFilters()" 
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300">Unread</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.status" value="read" @change="applyFilters()"
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300">Read</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.type" value="info" @change="applyFilters()"
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300 flex items-center">
                                <span class="h-2 w-2 rounded-full bg-blue-400 mr-2"></span>
                                Info
                            </span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.type" value="success" @change="applyFilters()"
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300 flex items-center">
                                <span class="h-2 w-2 rounded-full bg-green-400 mr-2"></span>
                                Success
                            </span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.type" value="warning" @change="applyFilters()"
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300 flex items-center">
                                <span class="h-2 w-2 rounded-full bg-yellow-400 mr-2"></span>
                                Warning
                            </span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="filters.type" value="error" @change="applyFilters()"
                                   class="rounded border-mystic bg-midnight text-neon focus:ring-neon focus:ring-offset-0">
                            <span class="ml-2 text-sm text-gray-300 flex items-center">
                                <span class="h-2 w-2 rounded-full bg-red-400 mr-2"></span>
                                Error
                            </span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date Range</label>
                    <div class="space-y-2">
                        <select x-model="filters.dateRange" @change="applyFilters()" 
                                class="w-full bg-midnight border border-mystic rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-neon">
                            <option value="all">All time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 days</option>
                            <option value="month">Last 30 days</option>
                            <option value="custom">Custom range</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-end">
                    <button @click="applyFilters()" 
                            class="w-full px-4 py-2 bg-neon text-white rounded-lg font-medium hover:bg-electric transition-colors">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="space-y-4" id="notifications-container">
        <div x-show="isLoading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-neon mx-auto"></div>
            <p class="text-gray-400 mt-4">Loading notifications<span class="loading-dots"></span></p>
        </div>
    
        <div x-show="!isLoading && filteredNotifications.length === 0" 
             x-cloak
             class="text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <h3 class="text-xl font-semibold text-white mb-2">No notifications yet</h3>
            <p class="text-gray-400 mb-6">When you get notifications, they'll appear here.</p>
            <button @click="loadNotifications()" 
                    class="px-6 py-2 bg-mystic text-white rounded-lg font-medium hover:bg-mystic/80 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                Refresh
            </button>
        </div>
    
        <template x-for="notification in paginatedNotifications" :key="notification.id">
            <div :class="{
                'bg-blue-500/10 border-blue-500/30': !notification.read,
                'bg-space-black border-mystic': notification.read
            }" class="rounded-lg border overflow-hidden transition-all duration-300 hover:shadow-lg notification-item">
                <div class="p-4 sm:p-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 mt-1">
                            <div :class="{
                                'bg-blue-500/20': notification.type === 'info',
                                'bg-green-500/20': notification.type === 'success',
                                'bg-yellow-500/20': notification.type === 'warning',
                                'bg-red-500/20': notification.type === 'error'
                            }" class="h-10 w-10 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :class="{
                                    'text-blue-400': notification.type === 'info',
                                    'text-green-400': notification.type === 'success',
                                    'text-yellow-400': notification.type === 'warning',
                                    'text-red-400': notification.type === 'error'
                                }" viewBox="0 0 20 20" fill="currentColor">
                                    <template x-if="notification.type === 'info'">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </template>
                                    <template x-if="notification.type === 'success'">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </template>
                                    <template x-if="notification.type === 'warning'">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </template>
                                    <template x-if="notification.type === 'error'">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </template>
                                </svg>
                            </div>
                        </div>
    
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-2">
                                <h3 class="text-lg font-semibold text-white" x-text="notification.title"></h3>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-400" 
                                          x-text="formatNotificationTime(notification.timestamp)"></span>
                                    <span x-show="!notification.read" 
                                          class="h-2 w-2 rounded-full bg-blue-400 animate-pulse notification-badge"></span>
                                </div>
                            </div>
                            
                            <p class="text-gray-300 mb-4" x-text="notification.message"></p>
                            
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                                <template x-if="notification.bill_type">
                                    <span :class="{
                                        'bg-yellow-500/20 text-yellow-300': notification.bill_type === 'kacha',
                                        'bg-green-500/20 text-green-300': notification.bill_type === 'pakka',
                                        'bg-blue-500/20 text-blue-300': notification.bill_type === 'draft'
                                    }" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium">
                                        <span x-text="notification.bill_type.charAt(0).toUpperCase() + notification.bill_type.slice(1)"></span>
                                        Bill
                                    </span>
                                </template>
                                <template x-if="notification.customer_name">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-mystic/30 text-gray-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                        </svg>
                                        <span x-text="notification.customer_name"></span>
                                    </span>
                                </template>
                                <template x-if="notification.amount">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-neon/20 text-neon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                        </svg>
                                        <span x-text="'â‚¹' + notification.amount"></span>
                                    </span>
                                </template>
                            </div>
    
                            <div class="flex flex-wrap items-center gap-2 pt-4 border-t border-mystic/50">
                                <template x-if="!notification.read">
                                    <button @click="markAsRead(notification.id)" 
                                            class="px-3 py-1.5 text-xs font-medium rounded-lg border border-blue-500 text-blue-400 hover:bg-blue-500/20 transition-colors flex items-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                        <span>Mark as read</span>
                                    </button>
                                </template>
                                <template x-if="notification.read">
                                    <button @click="markAsUnread(notification.id)" 
                                            class="px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-500 text-gray-400 hover:bg-gray-500/20 transition-colors flex items-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z" />
                                        </svg>
                                        <span>Mark as unread</span>
                                    </button>
                                </template>
                                <template x-if="notification.action_url">
                                    <a :href="notification.action_url" 
                                       class="px-3 py-1.5 text-xs font-medium rounded-lg bg-neon/10 border border-neon text-neon hover:bg-neon/20 transition-colors flex items-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                        <span>View details</span>
                                    </a>
                                </template>
                                <button @click="deleteNotification(notification.id)" 
                                        class="px-3 py-1.5 text-xs font-medium rounded-lg border border-red-500 text-red-400 hover:bg-red-500/20 transition-colors flex items-center space-x-1 ml-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div x-show="filteredNotifications.length > 0 && !isLoading" class="mt-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <p class="text-sm text-gray-400">
                Showing <span x-text="Math.min((currentPage - 1) * itemsPerPage + 1, totalCount)" class="font-medium text-white"></span>
                to <span x-text="Math.min(currentPage * itemsPerPage, totalCount)" class="font-medium text-white"></span>
                of <span x-text="totalCount" class="font-medium text-white"></span> notifications
            </p>
            <div class="flex items-center space-x-2">
                <button @click="previousPage()" 
                        :disabled="currentPage === 1"
                        :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-mystic/50'"
                        class="px-3 py-2 rounded-lg border border-mystic text-gray-300 text-sm font-medium transition-colors">
                    Previous
                </button>
                <div class="flex items-center space-x-1">
                    <template x-for="page in visiblePages" :key="page">
                        <button @click="goToPage(page)"
                                :class="page === currentPage ? 'bg-neon text-white' : 'bg-midnight text-gray-300 hover:bg-mystic/30'"
                                class="h-8 w-8 rounded-lg text-sm font-medium transition-colors">
                            <span x-text="page"></span>
                        </button>
                    </template>
                    <span x-show="showEllipsis" class="text-gray-400">...</span>
                </div>
                <button @click="nextPage()" 
                        :disabled="currentPage === totalPages"
                        :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-mystic/50'"
                        class="px-3 py-2 rounded-lg border border-mystic text-gray-300 text-sm font-medium transition-colors">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function notificationPage() {
        return {
            isLoading: false,
            notifications: [],
            filteredNotifications: [],
            unreadCount: 0,
            totalCount: 0,
            currentPage: 1,
            itemsPerPage: 20,
            totalPages: 1,
            showFilters: false,
            activeFilters: 0,
            
            filters: {
                status: [],
                type: [],
                dateRange: 'all'
            },
            
            get visiblePages() {
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
                let end = Math.min(this.totalPages, start + maxVisible - 1);
                
                if (end - start + 1 < maxVisible) {
                    start = Math.max(1, end - maxVisible + 1);
                }
                
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
                return pages;
            },
            
            get showEllipsis() {
                return this.totalPages > this.visiblePages[this.visiblePages.length - 1];
            },
            
            async loadNotifications() {
                this.isLoading = true;
                try {
                    const response = await fetch('/api/notifications/all/');
                    const data = await response.json();
                    if (data.status === 'success') {
                        this.notifications = data.notifications;
                        this.filteredNotifications = [...this.notifications];
                        this.unreadCount = data.unread_count;
                        this.totalCount = data.total_count;
                        this.calculatePagination();
                    }
                } catch (error) {
                    console.error('Failed to load notifications:', error);
                    showAppAlert('Failed to load notifications', 'error');
                } finally {
                    this.isLoading = false;
                }
            },
            
            applyFilters() {
                let filtered = [...this.notifications];
                
                // Apply status filter
                if (this.filters.status.length > 0) {
                    filtered = filtered.filter(notification => {
                        if (this.filters.status.includes('unread') && !notification.read) return true;
                        if (this.filters.status.includes('read') && notification.read) return true;
                        return false;
                    });
                }
                
                // Apply type filter
                if (this.filters.type.length > 0) {
                    filtered = filtered.filter(notification => 
                        this.filters.type.includes(notification.type)
                    );
                }
                
                // Apply date range filter
                if (this.filters.dateRange !== 'all') {
                    const now = new Date();
                    filtered = filtered.filter(notification => {
                        const notificationDate = new Date(notification.timestamp);
                        switch (this.filters.dateRange) {
                            case 'today':
                                return notificationDate.toDateString() === now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                                return notificationDate >= weekAgo;
                            case 'month':
                                const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                                return notificationDate >= monthAgo;
                            default:
                                return true;
                        }
                    });
                }
                
                this.filteredNotifications = filtered;
                this.currentPage = 1;
                this.calculatePagination();
                this.calculateActiveFilters();
            },
            
            clearFilters() {
                this.filters = {
                    status: [],
                    type: [],
                    dateRange: 'all'
                };
                this.filteredNotifications = [...this.notifications];
                this.currentPage = 1;
                this.calculatePagination();
                this.calculateActiveFilters();
            },
            
            calculateActiveFilters() {
                this.activeFilters = 
                    this.filters.status.length + 
                    this.filters.type.length + 
                    (this.filters.dateRange !== 'all' ? 1 : 0);
            },
            
            calculatePagination() {
                this.totalPages = Math.ceil(this.filteredNotifications.length / this.itemsPerPage);
                this.totalPages = Math.max(1, this.totalPages);
                if (this.currentPage > this.totalPages) {
                    this.currentPage = this.totalPages;
                }
            },
            
            get paginatedNotifications() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.filteredNotifications.slice(start, end);
            },
            
            toggleFilters() {
                this.showFilters = !this.showFilters;
            },
            
            async markAsRead(notificationId) {
                try {
                    const response = await fetch(`/api/notifications/${notificationId}/read/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.getCSRFToken(),
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        const notification = this.notifications.find(n => n.id === notificationId);
                        if (notification) {
                            notification.read = true;
                            this.unreadCount = Math.max(0, this.unreadCount - 1);
                            showAppAlert('Notification marked as read', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Failed to mark notification as read:', error);
                    showAppAlert('Failed to mark notification as read', 'error');
                }
            },
            
            async markAsUnread(notificationId) {
                try {
                    const response = await fetch(`/api/notifications/${notificationId}/unread/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.getCSRFToken(),
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        const notification = this.notifications.find(n => n.id === notificationId);
                        if (notification) {
                            notification.read = false;
                            this.unreadCount++;
                            showAppAlert('Notification marked as unread', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Failed to mark notification as unread:', error);
                    showAppAlert('Failed to mark notification as unread', 'error');
                }
            },
            
            async markAllAsRead() {
                if (this.unreadCount === 0) return;
                
                if (!confirm(`Are you sure you want to mark all ${this.unreadCount} notifications as read?`)) return;
                
                try {
                    const response = await fetch('/api/notifications/read-all/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.getCSRFToken(),
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        this.notifications.forEach(n => n.read = true);
                        this.unreadCount = 0;
                        showAppAlert('All notifications marked as read', 'success');
                    }
                } catch (error) {
                    console.error('Failed to mark all notifications as read:', error);
                    showAppAlert('Failed to mark notifications as read', 'error');
                }
            },
            
            async deleteNotification(notificationId) {
                if (!confirm('Are you sure you want to delete this notification?')) return;
                
                try {
                    const response = await fetch(`/api/notifications/${notificationId}/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': window.getCSRFToken(),
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        // Remove from all arrays
                        this.notifications = this.notifications.filter(n => n.id !== notificationId);
                        this.filteredNotifications = this.filteredNotifications.filter(n => n.id !== notificationId);
                        
                        // Update counts
                        this.totalCount--;
                        const notification = this.notifications.find(n => n.id === notificationId);
                        if (notification && !notification.read) {
                            this.unreadCount = Math.max(0, this.unreadCount - 1);
                        }
                        
                        this.calculatePagination();
                        showAppAlert('Notification deleted', 'success');
                    }
                } catch (error) {
                    console.error('Failed to delete notification:', error);
                    showAppAlert('Failed to delete notification', 'error');
                }
            },
            
            async clearAll() {
                if (this.totalCount === 0) return;
                
                if (!confirm(`Are you sure you want to delete all ${this.totalCount} notifications?`)) return;
                
                try {
                    const response = await fetch('/api/notifications/clear-all/', {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': window.getCSRFToken(),
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        this.notifications = [];
                        this.filteredNotifications = [];
                        this.unreadCount = 0;
                        this.totalCount = 0;
                        this.currentPage = 1;
                        showAppAlert('All notifications cleared', 'success');
                    }
                } catch (error) {
                    console.error('Failed to clear all notifications:', error);
                    showAppAlert('Failed to clear notifications', 'error');
                }
            },
            
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                }
            },
            
            nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                }
            },
            
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                }
            },
            
            formatNotificationTime(timestamp) {
                return window.formatNotificationTime(timestamp);
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('alpine:init', () => {
        Alpine.data('notificationPage', notificationPage);
    });
</script>
{% endblock %}